<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Report - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        .main-wrapper {
            min-height: 100vh;
        }

        .navbar {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-icon {
            color: #3b82f6;
            font-size: 20px;
        }

        .admin-text {
            font-weight: 600;
            color: #1e293b;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .export-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-pdf {
            background: #dc2626;
            color: white;
        }

        .export-excel {
            background: #059669;
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .icon-sales {
            background: #3b82f6;
        }

        .icon-orders {
            background: #06b6d4;
        }

        .icon-products {
            background: #8b5cf6;
        }

        .icon-discounts {
            background: #f59e0b;
        }

        .icon-returns {
            background: #ef4444;
        }

        .icon-revenue {
            background: #10b981;
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .card-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .card-subtitle {
            color: #94a3b8;
            font-size: 12px;
            margin-top: 4px;
        }

        .sales-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sales-table th {
            background: #f8fafc;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sales-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }

        .sales-table tbody tr {
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .sales-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .order-id {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #3b82f6;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-delivered {
            background: #dcfce7;
            color: #166534;
        }

        .status-processing {
            background: #fef3c7;
            color: #92400e;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pending {
            background: #e0e7ff;
            color: #3730a3;
        }

        .payment-method {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .payment-online {
            background: #dbeafe;
            color: #1e40af;
        }

        .payment-cod {
            background: #fed7aa;
            color: #9a3412;
        }
        .payment-wallet {
            background: #e0f2fe;
            color: #0369a1;
        }

        .amount {
            font-weight: 600;
            color: #1e293b;
        }

        .discount {
            color: #059669;
            font-weight: 600;
        }

        .coupon {
            background: #f3e8ff;
            color: #7c3aed;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .expand-icon {
            transition: transform 0.2s;
        }

        .expand-icon.rotated {
            transform: rotate(90deg);
        }

        .footer-stat-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .footer-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

        /* Responsive Design */
        @media (max-width: 991.98px) {
            .sales-table thead {
                display: none;
            }
            .sales-table tbody,
            .sales-table tr,
            .sales-table td {
                display: block;
                width: 100%;
            }
            .sales-table tr {
                margin-bottom: 1rem;
                border: 1px solid #dee2e6;
                border-radius: .5rem;
                background-color: #fff;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            .sales-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: .75rem 1rem;
                border-bottom: 1px solid #f1f1f1;
                text-align: right;
            }
            .sales-table td:last-child {
                border-bottom: 0;
            }
            .sales-table td::before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                margin-right: 1rem;
                color: #495057;
            }
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
        <!-- Include the header partial (this would be processed by EJS) -->
        <%- include('../partials/admin/header.ejs') %>

            <div class="content-wrapper p-3 p-md-4">
                <div class="navbar">
                    <div class="navbar-left">
                        <i class="fas fa-user-shield admin-icon"></i>
                        <span class="admin-text">Admin</span>
                    </div>
                </div>

                <!-- Page Header -->
                <div class="d-flex flex-wrap justify-content-between align-items-center my-4 gap-3">
                    <h1 class="h2 fw-bold text-dark d-flex align-items-center gap-2 mb-0">
                        <i class="fas fa-chart-line"></i>
                        Sales Report
                    </h1>
                    <div class="export-buttons">
                        <button class="btn btn-danger export-btn" id="exportPdfBtn">
                            <i class="fas fa-file-pdf"></i>
                            Export PDF
                        </button>
                        <button class="btn btn-success export-btn" id="exportExcelBtn">
                            <i class="fas fa-file-excel"></i>
                            Export Excel
                        </button>
                    </div>
                </div>

                <!-- Sales Summary Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-sm-6 col-lg-4 col-xl-2">
                        <div class="card summary-card h-100 border-0 shadow-sm">
                            <div class="card-body">
                            <div class="card-icon icon-sales">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                            <div class="card-value mt-3" id="totalSales"><%= (summary && summary.totalSales) ? '₹' + Number(summary.totalSales).toLocaleString('en-IN') : '₹0' %></div>
                            <div class="card-label">Total Sales</div>
                            <div class="card-subtitle">From delivered orders</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4 col-xl-2">
                        <div class="card summary-card h-100 border-0 shadow-sm">
                            <div class="card-body">
                            <div class="card-icon icon-orders">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="card-value mt-3" id="totalOrders"><%= (summary && summary.totalOrders) ? summary.totalOrders : 0 %></div>
                            <div class="card-label">Total Orders</div>
                            <div class="card-subtitle">All orders</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4 col-xl-2">
                        <div class="card summary-card h-100 border-0 shadow-sm">
                            <div class="card-body">
                            <div class="card-icon icon-products">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="card-value mt-3" id="productsSold"><%= (summary && summary.productsSold) ? summary.productsSold : 0 %></div>
                            <div class="card-label">Products Sold</div>
                            <div class="card-subtitle">Total quantity</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4 col-xl-2">
                        <div class="card summary-card h-100 border-0 shadow-sm">
                            <div class="card-body">
                            <div class="card-icon icon-discounts">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="card-value mt-3" id="totalDiscounts"><%= (summary && summary.totalDiscounts) ? '₹' + Number(summary.totalDiscounts).toLocaleString('en-IN') : '₹0' %></div>
                            <div class="card-label">Total Discounts</div>
                            <div class="card-subtitle">Coupon discounts</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4 col-xl-2">
                        <div class="card summary-card h-100 border-0 shadow-sm">
                            <div class="card-body">
                            <div class="card-icon icon-returns">
                                <i class="fas fa-undo"></i>
                            </div>
                            <div class="card-value mt-3" id="totalReturns"><%= (summary && summary.totalReturns) ? '₹' + Number(summary.totalReturns).toLocaleString('en-IN') : '₹0' %></div>
                            <div class="card-label">Total Returns</div>
                            <div class="card-subtitle">Cancelled orders</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-4 col-xl-2">
                        <div class="card summary-card h-100 border-0 shadow-sm">
                            <div class="card-body">
                            <div class="card-icon icon-revenue">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="card-value mt-3" id="netRevenue"><%= (summary && summary.netRevenue) ? '₹' + Number(summary.netRevenue).toLocaleString('en-IN') : '₹0' %></div>
                            <div class="card-label">Net Revenue</div>
                            <div class="card-subtitle">Sales - Returns</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-3 fw-semibold text-dark">
                        <i class="fas fa-filter"></i>
                        Filters & Controls
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-6 col-lg-3">
                            <label for="dateFilter" class="form-label small">Date Filter</label>
                            <select class="form-select" id="dateFilter">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <div class="col-md-6 col-lg-2">
                            <label for="statusFilter" class="form-label small">Order Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="all">All Status</option>
                                <option value="delivered">Delivered</option>
                                <option value="processing">Processing</option>
                                <option value="pending">Pending</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>

                        <div class="col-md-6 col-lg-2">
                            <label for="paymentFilter" class="form-label small">Payment Method</label>
                            <select class="form-select" id="paymentFilter">
                                <option value="all">All Methods</option>
                                <option value="online">Online</option>
                                <option value="cod">COD</option>
                            </select>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label for="customerSearch" class="form-label small">Search Customer</label>
                            <input type="text" class="form-control" id="customerSearch" placeholder="Customer name or email">
                        </div>

                        <div class="col-md-6 col-lg-2">
                            <label for="sortBy" class="form-label small">Sort By</label>
                            <select class="form-select" id="sortBy">
                                <option value="date-newest">Date (Newest First)</option>
                                <option value="date-oldest">Date (Oldest First)</option>
                                <option value="amount-high">Amount (High to Low)</option>
                                <option value="amount-low">Amount (Low to High)</option>
                            </select>
                        </div>

                        <div class="col-md-6 col-lg-2">
                            <label for="pageSize" class="form-label small">Rows per page</label>
                            <select class="form-select" id="pageSize">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>

                        <div class="col-md-12 col-lg-4" id="customDateGroup" style="display: none;">
                            <label class="form-label small">Custom Date Range</label>
                            <div class="d-flex gap-2">
                                <input type="date" class="form-control" id="startDate">
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-check"></i>
                            Apply Filters
                        </button>
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Clear
                        </button>
                    </div>
                    </div>
                </div>

                <!-- Sales Table -->
                <div class="card shadow-sm">
                    <div class="card-header bg-light d-flex align-items-center gap-2 fw-semibold text-dark">
                        <i class="fas fa-table"></i>
                        Detailed Sales Table
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle sales-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Order Date</th>
                                    <th>Customer Name</th>
                                    <th>Payment Method</th>
                                    <th>Order Status</th>
                                    <th>Product Name</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Coupon Discount</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-light d-flex flex-wrap justify-content-between align-items-center gap-3">
                        
                        <div class="pagination-area d-flex align-items-center gap-3">
                            <% const pg = (typeof pagination !== 'undefined' && pagination) ? pagination : {}; 
                               const cp = pg.currentPage || 1; 
                               const lim = pg.limit || 10; 
                               const tc = pg.totalCount || 0; 
                               const startIdx = tc ? ((cp - 1) * lim + 1) : 0; 
                               const endIdx = Math.min(cp * lim, tc); 
                               const tp = pg.totalPages || 1; %>
                            <div class="text-muted small pagination-info">Showing <%= startIdx %>–<%= endIdx %> of <%= tc %></div>
                            <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item <%= cp === 1 ? 'disabled' : '' %>"><button class="page-link" onclick="goToPage(<%= cp - 1 %>)">Prev</button></li>
                                <% if (tp <= 7) { %>
                                    <% for (let p = 1; p <= tp; p++) { %>
                                        <li class="page-item <%= p === cp ? 'active' : '' %>"><button class="page-link" onclick="goToPage(<%= p %>)"><%= p %></button></li>
                                    <% } %>
                                <% } else { %>
                                    <li class="page-item <%= 1 === cp ? 'active' : '' %>"><button class="page-link" onclick="goToPage(1)">1</button></li>
                                    <% if (cp > 3) { %><li class="page-item disabled"><span class="page-link">...</span></li><% } %>
                                    <% const start = Math.max(2, cp - 1); const end = Math.min(tp - 1, cp + 1); %>
                                    <% for (let p = start; p <= end; p++) { %>
                                        <li class="page-item <%= p === cp ? 'active' : '' %>"><button class="page-link" onclick="goToPage(<%= p %>)"><%= p %></button></li>
                                    <% } %>
                                    <% if (cp < tp - 2) { %><li class="page-item disabled"><span class="page-link">...</span></li><% } %>
                                    <li class="page-item <%= tp === cp ? 'active' : '' %>"><button class="page-link" onclick="goToPage(<%= tp %>)"><%= tp %></button></li>
                                <% } %>
                                <li class="page-item <%= cp === tp ? 'disabled' : '' %>"><button class="page-link" onclick="goToPage(<%= cp + 1 %>)">Next</button></li>
                            </ul>
                            </nav>
                        </div>
                    </div>

                    
                </div>
            </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Server-provided data
        let salesData = <%- JSON.stringify(salesData || []) %>;
        let expandedRows = new Set();
        const initialSummary = <%- JSON.stringify(summary || {}) %>;
        const pagination = <%- JSON.stringify(pagination || {}) %>;

        function formatCurrency(amount) {
            return `₹${amount.toLocaleString()}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function getStatusClass(status) {
            return `status-${status.toLowerCase()}`;
        }

        function getPaymentClass(method) {
            return `payment-${method.toLowerCase()}`;
        }

        function renderTable() {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';

            if (!salesData || salesData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-5">No results found</td></tr>`;
                return;
            }

            salesData.forEach(item => {
                // Main row
                const mainRow = document.createElement('tr');
                mainRow.setAttribute('data-label', 'Order');
                mainRow.innerHTML = `
                    <td data-label="Order ID"><span class="order-id">${item.id}</span></td>
                    <td data-label="Date">${formatDate(item.date)}</td>
                    <td data-label="Customer">${item.customerName}</td>
                    <td data-label="Payment">
                        <span class="payment-method ${getPaymentClass(item.paymentMethod)}">
                            ${item.paymentMethod}
                        </span>
                    </td>
                    <td data-label="Status">
                        <span class="status-badge ${getStatusClass(item.status)}">
                            ${item.status}
                        </span>
                    </td>
                    <td data-label="Product">${item.productName}</td>
                    <td data-label="Qty">${item.quantity}</td>
                    <td data-label="Price" class="amount">${formatCurrency(item.price)}</td>
                    <td data-label="Coupon" class="discount">${formatCurrency(item.couponDiscount)}</td>
                `;
                tbody.appendChild(mainRow);
            });
        }

        function applyFilters(page = 1) {
            const dateFilter = document.getElementById('dateFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            const customerSearch = document.getElementById('customerSearch').value.trim();
            const sortBy = document.getElementById('sortBy').value;
            const pageSizeEl = document.getElementById('pageSize');
            const currentLimit = pageSizeEl ? pageSizeEl.value : (pagination?.limit || 10);
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Build URL params (server-side pagination and filters)
            const params = new URLSearchParams();
            params.set('page', String(page));
            params.set('limit', String(currentLimit));
            if (statusFilter && statusFilter !== 'all') params.set('status', statusFilter);
            if (paymentFilter && paymentFilter !== 'all') params.set('payment', paymentFilter);
            // For custom range, send dates. Otherwise, just send the filter name.
            if (dateFilter === 'custom' && startDate) params.set('startDate', startDate);
            if (dateFilter === 'custom' && endDate) params.set('endDate', endDate);
            if (customerSearch) params.set('search', customerSearch);
            if (sortBy) params.set('sort', sortBy);
            if (dateFilter && dateFilter !== 'all') params.set('dateFilter', dateFilter);

            const url = `/sales?${params.toString()}`;
            // Update browser history without reloading
            history.pushState({ path: url }, '', url);

            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                updateUI(data);
            })
            .catch(error => {
                console.error('Fetch error:', error);
                const tbody = document.getElementById('salesTableBody');
                tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:20px; color:#dc2626;">Failed to load data. Please try again.</td></tr>`;
            });

            // const url = new URL(window.location.href);
            // url.search = params.toString();
            // window.location.href = url.toString();
        }

        function clearFilters() {
            // Reset all filter inputs to their default values
            document.getElementById('dateFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('paymentFilter').value = 'all';
            document.getElementById('customerSearch').value = '';
            document.getElementById('sortBy').value = 'date-newest';
            document.getElementById('pageSize').value = '10'; // Assuming 10 is the default page size
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            // Hide custom date inputs if they were visible
            document.getElementById('customDateGroup').style.display = 'none';

            // Update URL in browser history without reloading the page
            history.pushState({ path: window.location.pathname }, '', window.location.pathname);

            // Apply filters to fetch data with cleared parameters
            applyFilters(1); // Go back to the first page with cleared filters
        }

        function goToPage(n) {
            if (!pagination || !pagination.totalPages) return;
            const tp = pagination.totalPages;
            if (n < 1 || n > tp) return;
            applyFilters(n);
        }

        function updateUI(data) {
            // Update summary cards
            document.getElementById('totalSales').textContent = formatCurrency(data.summary.totalSales || 0);
            document.getElementById('totalOrders').textContent = data.summary.totalOrders || 0;
            document.getElementById('productsSold').textContent = data.summary.productsSold || 0;
            document.getElementById('totalDiscounts').textContent = formatCurrency(data.summary.totalDiscounts || 0);
            document.getElementById('totalReturns').textContent = formatCurrency(data.summary.totalReturns || 0);
            document.getElementById('netRevenue').textContent = formatCurrency(data.summary.netRevenue || 0);

            // Update table data and re-render
            salesData = data.salesData;
            renderTable();

            // Update pagination
            renderPagination(data.pagination);
        }

        function renderPagination(pg) {
            const paginationArea = document.querySelector('.pagination-area ul.pagination');
            if (!pg || pg.totalCount === 0) {
                document.querySelector('.pagination-info').textContent = 'No results';
                if(paginationArea) paginationArea.innerHTML = '';
                return;
            }
            const { currentPage: cp, totalPages: tp, totalCount: tc, limit: lim } = pg;
            const startIdx = tc ? ((cp - 1) * lim + 1) : 0;
            const endIdx = Math.min(cp * lim, tc);

            document.querySelector('.pagination-info').textContent = `Showing ${startIdx}–${endIdx} of ${tc}`;

            let paginationHtml = `<li class="page-item ${cp === 1 ? 'disabled' : ''}"><button class="page-link" onclick="goToPage(${cp - 1})">Prev</button></li>`;
            
            // Simplified pagination buttons for dynamic rendering
            for (let p = 1; p <= tp; p++) {
                 // In a real app with many pages, you'd add logic for '...'
                 paginationHtml += `<li class="page-item ${p === cp ? 'active' : ''}"><button class="page-link" onclick="goToPage(${p})">${p}</button></li>`;
            }

            paginationHtml += `<li class="page-item ${cp === tp ? 'disabled' : ''}"><button class="page-link" onclick="goToPage(${cp + 1})">Next</button></li>`;
            paginationArea.innerHTML = paginationHtml;
        }

        // --- Report Download Functionality ---
        const downloadReport = (format) => {
            const btnId = format === 'pdf' ? 'exportPdfBtn' : 'exportExcelBtn';
            const btn = document.getElementById(btnId);
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            btn.disabled = true;

            // 1. Gather all current filters
            const dateFilter = document.getElementById('dateFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            const customerSearch = document.getElementById('customerSearch').value.trim();
            const sortBy = document.getElementById('sortBy').value;
            let startDate = document.getElementById('startDate').value;
            let endDate = document.getElementById('endDate').value;

            // 2. Build URL params
            const params = new URLSearchParams();
            if (statusFilter && statusFilter !== 'all') params.set('status', statusFilter);
            if (paymentFilter && paymentFilter !== 'all') params.set('payment', paymentFilter);
            if (dateFilter === 'custom' && startDate) params.set('startDate', startDate);
            if (dateFilter === 'custom' && endDate) params.set('endDate', endDate);
            if (customerSearch) params.set('search', customerSearch);
            if (sortBy) params.set('sort', sortBy);
            if (dateFilter && dateFilter !== 'all') params.set('dateFilter', dateFilter);

            const endpoint = format === 'pdf' ? '/sales/download-report' : '/sales/download-report-excel';
            const fileExtension = format === 'pdf' ? 'pdf' : 'xlsx';

            const url = `${endpoint}?${params.toString()}`;

            // 3. Fetch the report as a blob
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = downloadUrl;
                    a.download = `sales-report-${new Date().toISOString().split('T')[0]}.${fileExtension}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                }).finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        };

        // Show/hide custom date inputs based on date filter selection
        document.getElementById('dateFilter').addEventListener('change', function () {
            const customDateInputs = document.getElementById('customDateGroup');
            if (this.value === 'custom') {
                customDateInputs.style.display = 'flex';
            } else {
                customDateInputs.style.display = 'none';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
            }
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function syncFiltersFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const dateFilterEl = document.getElementById('dateFilter');
            const statusEl = document.getElementById('statusFilter');
            const paymentEl = document.getElementById('paymentFilter');
            const searchEl = document.getElementById('customerSearch');
            const sortEl = document.getElementById('sortBy');
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            const pageSizeEl = document.getElementById('pageSize');

            const status = params.get('status');
            const payment = params.get('payment');
            const dateFilter = params.get('dateFilter');
            const startDate = params.get('startDate');
            const endDate = params.get('endDate');
            const search = params.get('search');
            const sort = params.get('sort');
            const limit = params.get('limit');

            if (status) statusEl.value = status.toLowerCase();
            if (payment) paymentEl.value = payment.toLowerCase();
            if (sort) sortEl.value = sort;
            if (search) searchEl.value = search;
            if (pageSizeEl) pageSizeEl.value = limit || (pagination && pagination.limit) || '10';

            if (startDate || endDate) {
                startEl.value = startDate || '';
                endEl.value = endDate || '';
                dateFilterEl.value = 'custom';
            } else if (dateFilter) {
                dateFilterEl.value = dateFilter;
            } else {
                dateFilterEl.value = 'all';
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            syncFiltersFromQuery();
            const customDateInputs = document.getElementById('customDateGroup');
            if (document.getElementById('dateFilter').value === 'custom') {
                customDateInputs.style.display = 'flex';
            } else {
                customDateInputs.style.display = 'none';
            }

            // Initial render
            renderTable();
            if (typeof initialSummary === 'object' && initialSummary && initialSummary.totalSales !== undefined) {
                document.getElementById('totalSales').textContent = formatCurrency(initialSummary.totalSales || 0);
                document.getElementById('totalOrders').textContent = initialSummary.totalOrders || 0;
                document.getElementById('productsSold').textContent = initialSummary.productsSold || 0;
                document.getElementById('totalDiscounts').textContent = formatCurrency(initialSummary.totalDiscounts || 0);
                document.getElementById('totalReturns').textContent = formatCurrency(initialSummary.totalReturns || 0);
                document.getElementById('netRevenue').textContent = formatCurrency(initialSummary.netRevenue || 0);
            }

            // Add debounced event listener for the PDF export button
            document.getElementById('exportPdfBtn').addEventListener('click', debounce(() => downloadReport('pdf'), 1000));
            document.getElementById('exportExcelBtn').addEventListener('click', debounce(() => downloadReport('excel'), 1000));
        });

    </script>
</body>

</html>